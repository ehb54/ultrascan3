# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, lukas/qt6-compile ]
    paths:
      - '**.c'
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - '**.pro'
      - '**.pri'
      - 'programs/main1.inc'
      - '**CMakeLists.txt'
      - '**.json'
      - '**.qrc'
      - '**.ui'
      - '.github/workflows/codeql-analysis.yml'
      - 'admin/codeql/docker/local.**'
  schedule:
    - cron: '20 18 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  changed-files:
    runs-on: ubuntu-latest  # windows-latest || macos-latest
    name: Get changed files
    permissions:
      pull-requests: read
    outputs:
      # reference: https://github.com/tj-actions/changed-files#outputs-
      somo: ${{ steps.changed-files.outputs.somo_any_modified == 'true' }}
      mpi: ${{ steps.changed-files.outputs.mpi_any_modified == 'true' }}
      programs: ${{ steps.changed-files.outputs.programs_any_modified == 'true' }}
      utils: ${{ steps.changed-files.outputs.utils_any_modified == 'true' }}
      gui: ${{ steps.changed-files.outputs.gui_any_modified == 'true' }}
      qwtplot3d: ${{ steps.changed-files.outputs.qwtplot3d_any_modified == 'true' }}
      
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Get changed files
        if: ${{ github.event_name != 'schedule' || !env.ACT }}
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files_yaml: |
            workflow: &workflow
              - .github/workflows/codeql-analysis.yml
            utils: &utils
              - library.pri
              - utils/**
            qwtplot3d: &qwtplot3d
              - library.pri
              - qwtplot3d/**
            gui: &gui
              - *utils
              - *qwtplot3d
              - gui/**
            programs: &programs
              - *gui
              - gui.pri
              - programs/**
              - admin/codeql/docker/local.pri.gui
              - *workflow
            mpi: &mpi
              - *utils
              - programs/us_mpi_analysis/**
              - admin/codeql/docker/local.pri.mpi
              - *workflow
            somo: &somo
              - somo/**
              - us_somo/**
              - admin/codeql/docker/local.pri.somo
              - *workflow
  analyze-mpi:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.mpi == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze mpi
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          # enable qt6 after pr 300 merged
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Build
        run: |
          cp admin/codeql/docker/local.pri.mpi local.pri
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          cd utils
          qmake
          make -j$(nproc)
          cd ..
          cd programs/us_mpi_analysis
          qmake
          make -j$(nproc)
          cd ../..
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  analyze-gui:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.programs == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze gui programs
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          # enable qt6 & qwt630 after pr 300 merged
          # - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.3.0"
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Install ccache
        if: ${{ github.event_name != 'schedule' }}
        run: |
          apt-get update && apt-get install -y ccache
          # Prepend ccache to PATH so it intercepts gcc/g++ calls
          echo "/usr/lib/ccache" >> $GITHUB_PATH
      - name: Cache build files
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ matrix.container }}-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-ccache-${{ matrix.container }}-${{ github.ref }}
            ${{ runner.os }}-ccache-${{ matrix.container }}
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Prepare build
        run: |
          export CCACHE_DIR=/root/.ccache
          ccache -M 2G
          ccache -s
          cp admin/codeql/docker/local.pri.gui local.pri
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
      - name: Cache Utils
        id: cache-utils
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/cache@v4
        with:
          path: |
            ./utils/
            ./lib/libus_utils*
          key: ${{ runner.os }}-utils-${{ matrix.container }}-${{ hashFiles('utils/**.cpp', 'utils/**.h', 'utils/**.pro', 'library.pri', 'make_all.pro', 'local.pri') }}
      - name: Cache qwtplot3d
        id: cache-qwtplot3d
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/cache@v4
        with:
          path: |
            ./qwtplot3d/
            ./lib/libqwtplot3d*
          key: ${{ runner.os }}-qwtplot3d-${{ matrix.container }}-${{ hashFiles('qwtplot3d/**.cpp', 'qwtplot3d/**.h', 'qwtplot3d/**.c', 'qwtplot3d/**.hpp', 'qwtplot3d/**.pro', 'library.pri', 'make_all.pro', 'local.pri') }}
      - name: Cache gui
        id: cache-gui
        if: ${{ github.event_name != 'schedule' }}
        uses: actions/cache@v4
        with:
          path: |
            ./gui/
            ./lib/libus_gui*
          key: ${{ runner.os }}-gui-${{ matrix.container }}-${{ hashFiles('gui/**.cpp', 'gui/**.h', 'gui/**.pro', 'library.pri', 'make_all.pro', 'local.pri') }}
      - name: Build Utils
        if: ${{ steps.cache-utils.outputs.cache-hit != 'true' }}
        id: build-utils
        run: |
          cd utils
          qmake
          make -j$(nproc)
      - name: Build qwtplot3d
        if: ${{ steps.cache-qwtplot3d.outputs.cache-hit != 'true' }}
        id: build-qwtplot3d
        run: |
          cd qwtplot3d
          qmake
          make -j$(nproc)
      - name: Build gui
        if: ${{ steps.cache-gui.outputs.cache-hit != 'true' || needs.changed-files.outputs.utils == 'true' || needs.changed-files.outputs.qwtplot3d == 'true' }}
        id: build-gui
        run: |
          cd gui
          qmake
          make -j$(nproc)
      
          
      - name: Build programs
        run: |
          # Setup ccache
          export CCACHE_DIR=/root/.ccache
          ccache -M 2G
          ccache -s
          cp admin/codeql/docker/local.pri.gui local.pri
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          (cd programs/us && sh revision.sh)
          qmake
          make -j$(nproc)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  analyze-somo:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.somo == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze somo
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          # somo main not ready for qwt6.3.0
          # - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.3.0"
          # somo main not ready for qt6
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Build
        run: |
          bdir=`pwd`
          echo $bdir
          pwd
          export ULTRASCAN=$bdir
          export us3=$bdir
          cd us_somo/develop
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          ./revision.sh
          ./version.sh
          cp $bdir/admin/codeql/docker/local.pri.somo local.pri
          qmake libus_somo.pro
          make -j$(nproc)
          qmake us_somo.pro
          make -j$(nproc)
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
