# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
#
# ******** NOTE ********
# We have attempted to detect the languages in your repository. Please check
# the `language` matrix defined below to confirm you have the correct set of
# supported CodeQL languages.
#
name: "CodeQL"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main, lukas/qt6-compile ]
    paths:
      - '**.c'
      - '**.cpp'
      - '**.h'
      - '**.hpp'
      - '**.pro'
      - '**.pri'
      - 'programs/main1.inc'
      - '**CMakeLists.txt'
      - '**.json'
      - '**.qrc'
      - '**.ui'
      - '.github/workflows/codeql-analysis.yml'
      - 'admin/codeql/docker/local.**'
  schedule:
    - cron: '20 18 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  changed-files:
    runs-on: ubuntu-latest  # windows-latest || macos-latest
    name: Get changed files
    permissions:
      pull-requests: read
    outputs:
      # reference: https://github.com/tj-actions/changed-files#outputs-
      somo: ${{ steps.changed-files.outputs.somo_any_modified == 'true' }}
      mpi: ${{ steps.changed-files.outputs.mpi_any_modified == 'true' }}
      gui: ${{ steps.changed-files.outputs.programs_any_modified == 'true' }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Get changed files
        if: ${{ github.event_name != 'schedule' || !env.ACT }}
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files_yaml: |
            workflow: &workflow
              - .github/workflows/codeql-analysis.yml
            utils: &utils
              - library.pri
              - utils/**
            qwtplot3d: &qwtplot3d
              - library.pri
              - qwtplot3d/**
            gui: &gui
              - *utils
              - *qwtplot3d
              - gui/**
            programs: &programs
              - *gui
              - gui.pri
              - programs/**
              - admin/codeql/docker/local.pri.gui
              - *workflow
            mpi: &mpi
              - *utils
              - programs/us_mpi_analysis/**
              - admin/codeql/docker/local.pri.mpi
              - *workflow
            somo: &somo
              - somo/**
              - us_somo/**
              - admin/codeql/docker/local.pri.somo
              - *workflow
  analyze-mpi:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.mpi == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze mpi
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}
      options: --cpus 4

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Build
        run: |
          cp admin/codeql/docker/local.pri.mpi local.pri
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          cd utils
          qmake
          make -j8
          cd ..
          cd programs/us_mpi_analysis
          qmake
          make -j8
          cd ../..
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  analyze-gui:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.gui == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze gui
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.3.0"
          - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}
      options: --cpus 4

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Build
        run: |
          cp admin/codeql/docker/local.pri.gui local.pri
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          (cd programs/us && sh revision.sh)
          qmake
          make -j8
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4

  analyze-somo:
    needs: [ changed-files ]
    if: ${{ needs.changed-files.outputs.somo == 'true' || github.event_name == 'schedule' || github.event.act == 'true' }}
    name: Analyze somo
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      actions: read

    strategy:
      fail-fast: false
      matrix:
        language: [cpp]
        container:
          - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.1.6"
          # somo main not ready for qwt6.3.0
          # - "ehb1/usbuildtest:ubuntu22.04-qt5.15.10-qwt6.3.0"
          # somo main not ready for qt6
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.8.3-qwt6.3.0"
          # - "ehb1/usbuildtest:ubuntu24.04-qt6.10.0-qwt6.3.0"

    # Specify the container in which actions will run
    container:
      image: ${{ matrix.container }}
      options: --cpus 4

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 1
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: ${{ matrix.language }}
      - name: Build
        run: |
          bdir=`pwd`
          echo $bdir
          pwd
          export ULTRASCAN=$bdir
          export us3=$bdir
          cd us_somo/develop
          git config --global --add safe.directory /__w/ultrascan3/ultrascan3
          ./revision.sh
          ./version.sh
          cp $bdir/admin/codeql/docker/local.pri.somo local.pri
          qmake libus_somo.pro
          make -j8
          qmake us_somo.pro
          make -j8
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
